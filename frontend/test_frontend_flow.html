<!DOCTYPE html>
<html>
<head>
    <title>Frontend Flow Test</title>
    <style>
        body { font-family: monospace; background: #0b0f14; color: #e6e6e6; padding: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #161b22; border-left: 3px solid #58a6ff; }
        .success { border-left-color: #3fb950; }
        .error { border-left-color: #f85149; }
        .info { border-left-color: #ff9f1c; }
    </style>
</head>
<body>
    <h1>Frontend Flow Test</h1>
    <div id="logs"></div>
    <script>
        const proto = window.location.protocol;
        const host = window.location.hostname;
        let apiHost = host;
        
        const m = host.match(/^(.*)-(\d+)\.app\.github\.dev$/);
        if (m) {
            apiHost = `${m[1]}-8000.app.github.dev`;
        }
        if (host === "localhost" || host === "127.0.0.1") {
            apiHost = `${host}:8000`;
        }
        
        const API_BASE = `${proto}//${apiHost}`;
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = msg;
            document.getElementById('logs').appendChild(div);
            console.log(msg);
        }
        
        async function test() {
            log(`API_BASE: ${API_BASE}`, 'info');
            
            try {
                // Test chart endpoint
                log('üîÑ Testing /chart endpoint...', 'info');
                const chartRes = await fetch(`${API_BASE}/api/v1/chart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bars: 10, timeframe: '5m' })
                });
                const chartData = await chartRes.json();
                log(`‚úÖ Chart endpoint responded with ${chartData.bars?.length || 0} bars and ${chartData.iceberg_zones?.length || 0} zones`, 'success');
                
                if (chartData.iceberg_zones && chartData.iceberg_zones.length > 0) {
                    log(`‚úÖ Found ${chartData.iceberg_zones.length} iceberg zones:`, 'success');
                    chartData.iceberg_zones.slice(0, 3).forEach((z, i) => {
                        log(`  Zone ${i}: $${z.price_bottom.toFixed(2)} - $${z.price_top.toFixed(2)} (vol: ${z.volume_indicator})`, 'info');
                    });
                }
                
                // Test mentor endpoint
                log('üîÑ Testing /mentor endpoint...', 'info');
                const mentorRes = await fetch(`${API_BASE}/api/v1/mentor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: 'XAUUSD', refresh: true })
                });
                const mentorData = await mentorRes.json();
                log(`‚úÖ Mentor endpoint responded`, 'success');
                
                if (mentorData.iceberg_activity) {
                    log(`‚úÖ Iceberg activity detected: ${mentorData.iceberg_activity.detected}`, mentorData.iceberg_activity.detected ? 'success' : 'error');
                    log(`  Zones: ${mentorData.iceberg_activity.absorption_count}`, 'info');
                    log(`  Price: $${mentorData.iceberg_activity.price_from?.toFixed(2)} - $${mentorData.iceberg_activity.price_to?.toFixed(2)}`, 'info');
                    log(`  Volume spike: ${mentorData.iceberg_activity.volume_spike_ratio?.toFixed(2)}x`, 'info');
                }
                
                log('‚úÖ All tests passed! Frontend ready to display iceberg data.', 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Run test on page load
        window.addEventListener('load', test);
    </script>
</body>
</html>
